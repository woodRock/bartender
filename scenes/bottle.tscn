[gd_scene format=3 uid="uid://cua8570fwka16"]

[ext_resource type="Texture2D" uid="uid://v0u7bi636hxn" path="res://assets/sprites/items/spirits/vodka.png" id="2_qr18b"]

[sub_resource type="GDScript" id="GDScript_724mw"]
script/source = "extends Area2D

# --- Configuration ---
@export var data: IngredientData 
@export var ingredient_name: String = \"Vodka\"
@export var bottle_texture: Texture2D:
	set(value):
		bottle_texture = value
		_update_bottle_visuals()

# --- Audio Preloads ---
var snd_open = preload(\"res://assets/sounds/bottle_open.mp3\")
var snd_can = preload(\"res://assets/sounds/can_open.mp3\")
var snd_pour = preload(\"res://assets/sounds/pour.mp3\")

# --- Nodes ---
@onready var sprite = $Sprite2D
@onready var pour_particles = $Sprite2D/CPUParticles2D 
@onready var sfx_open = AudioStreamPlayer2D.new()
@onready var sfx_pour = AudioStreamPlayer2D.new()

# --- State ---
var dragging: bool = false
var has_opened: bool = false
var start_pos: Vector2
var active_tween: Tween
var last_mouse_pos: Vector2
var velocity: Vector2
var initial_scale: Vector2

func _ready():
	initial_scale = scale 
	start_pos = global_position
	add_to_group(\"draggables\")
	
	add_child(sfx_open)
	add_child(sfx_pour)
	sfx_pour.stream = snd_pour
	
	_update_bottle_visuals()

func _update_bottle_visuals():
	if not is_node_ready(): return
	if sprite and bottle_texture:
		sprite.texture = bottle_texture
		var tex_h = bottle_texture.get_height()
		sprite.offset.y = -tex_h / 2.0 if sprite.centered else -tex_h
		if pour_particles:
			pour_particles.z_index = 20 # Ensure particles are above the bottle
			pour_particles.position = Vector2(0, -tex_h - 5)
			_set_particle_color()

func _set_particle_color():
	if data:
		pour_particles.color = data.liquid_color
	else:
		pour_particles.color = Color.WHITE

func _process(delta):
	if dragging:
		var current_mouse_pos = get_global_mouse_position()
		global_position = current_mouse_pos
		velocity = (current_mouse_pos - last_mouse_pos) / delta
		last_mouse_pos = current_mouse_pos
		
		# --- RELIABLE SHAKER SEARCH ---
		var shaker_ref = get_tree().get_first_node_in_group(\"shaker\")
		var is_near_shaker = false
		
		if shaker_ref:
			var dist = global_position.distance_to(shaker_ref.global_position)
			if dist < 300: # Broad range for detection
				is_near_shaker = true
		
		# --- DEBUG LOGGING ---
		if Engine.get_frames_drawn() % 60 == 0: # Prints once per second
			print(\"--- BOTTLE DEBUG ---\")
			print(\"Dragging: \", dragging)
			print(\"Shaker in Group 'shaker' Found: \", shaker_ref != null)
			print(\"Is Near Shaker (<300px): \", is_near_shaker)

		# --- ROTATION LOGIC ---
		var target_tilt = deg_to_rad(90.0) if is_near_shaker else clamp(velocity.x * -0.015, -0.6, 0.6)
		rotation = lerp_angle(rotation, target_tilt, 0.2) 

		# --- POUR TRIGGER ---
		# If you are near the shaker OR you have manually tilted the bottle past 45 degrees
		if is_near_shaker or abs(rad_to_deg(rotation)) > 45.0:
			_start_pouring_effects()
			if is_near_shaker and shaker_ref:
				_pour_into_shaker(shaker_ref) 
		else:
			_stop_pouring_effects()

		# Physical stretch logic
		if active_tween == null or not active_tween.is_running():
			var stretch = clamp(velocity.length() / 3000.0, 0.0, 0.1)
			scale = scale.lerp(initial_scale * Vector2(1.0 - stretch, 1.0 + stretch), 0.2)
	else:
		_stop_pouring_effects()

func _start_pouring_effects():
	if pour_particles and not pour_particles.emitting:
		print(\"STARTING PARTICLES\")
		pour_particles.emitting = true
	if sfx_pour and not sfx_pour.playing:
		sfx_pour.play()

func _stop_pouring_effects():
	if pour_particles and pour_particles.emitting:
		pour_particles.emitting = false
	if sfx_pour and sfx_pour.playing:
		sfx_pour.stop()

func _pour_into_shaker(shaker):
	# Match the 4-argument shaker signature
	var p_name = data.ingredient_name if data else ingredient_name
	var p_color = data.liquid_color if data else Color.WHITE
	var p_solid = data.is_solid if data else false
	var p_density = data.density if data else 1
	shaker.add_ingredient(p_name, p_color, p_solid, p_density)

func pick_up():
	if active_tween: active_tween.kill()
	if not has_opened:
		sfx_open.play()
		has_opened = true
	
	dragging = true # Safety check
	active_tween = create_tween()
	active_tween.tween_property(self, \"scale\", initial_scale * Vector2(0.85, 1.2), 0.1)
	active_tween.tween_property(self, \"scale\", initial_scale, 0.1)

func _check_drop():
	dragging = false
	has_opened = false 
	_return_to_shelf()

func _return_to_shelf():
	if active_tween: active_tween.kill()
	active_tween = create_tween().set_parallel(true)
	active_tween.tween_property(self, \"global_position\", start_pos, 0.4).set_trans(Tween.TRANS_BACK)
	active_tween.tween_property(self, \"rotation\", 0.0, 0.3)
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_a0avw"]
size = Vector2(56, 201)

[node name="Bottle" type="Area2D" unique_id=719493021 groups=["draggables"]]
script = SubResource("GDScript_724mw")

[node name="Sprite2D" type="Sprite2D" parent="." unique_id=1298498853]
scale = Vector2(0.2, 0.2)
texture = ExtResource("2_qr18b")

[node name="CPUParticles2D" type="CPUParticles2D" parent="Sprite2D" unique_id=1498500851]
position = Vector2(0, -299.99997)
emitting = false
amount = 20
lifetime = 0.5
direction = Vector2(0, 1)
spread = 10.0
initial_velocity_min = 100.0
initial_velocity_max = 200.0
scale_amount_min = 2.0
scale_amount_max = 4.0

[node name="CollisionShape2D" type="CollisionShape2D" parent="." unique_id=267468521]
position = Vector2(-1, -1.5)
shape = SubResource("RectangleShape2D_a0avw")
